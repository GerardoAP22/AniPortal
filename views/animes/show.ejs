<%- include('../partials/header') %>

<div class="container">

<section class="anime-details">
    <div class="title">Title:</div>
    <div class="anime-title"><%= anime.title %></div>
    <div class="contain">
        <div class="image">
            <img src="<%= anime.image %>" alt="">
        </div>
        <div class="synopsis">
            <div class="synopsis-title">Synopsis:</div>
            <div class="synopsis-content"><%= anime.synopsis %></div>
        </div>
    </div>
    <div class="type">Type: <%= anime.type %></div>
    <div class="release-date">Release Date: <%= anime.releaseSeason %> , <%= anime.releaseYear %></div>
    <div class="genre">Genre: <%= anime.genre %></div>
    <div class="episode-count">Episode Count: <%= anime.episodeCount %></div>
    <div class="rating">Rating: <%= anime.rating %></div>
    <div class="currently-airing">Currently Airing: <%= anime.currentlyAiring ? 'Yes' : 'No' %></div>
    <% if(user) { %>
        <form action="/animes/<%= anime._id %>" method="POST" class="add-to-list">
            <button type="submit" value="add">Add to My List</button>
        </form>
    <% } %>
</section>

<h2>Reviews</h2>
<% if (user) { %>
    <button id="openModalBtn">Add Review</button>

    <div id="myModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" id="closeModalBtn">&times;</span>
            <h2>Add Review: </h2>
            <form id="modalForm" method="POST" action="/animes/<%= anime._id %>/reviews">
                <label>Review:</label>
                <textarea name="content"></textarea>
                <label>Rating:</label>
                <select name="rating">
                    <option value="1">1</option>
                    <!-- ... (other options) ... -->
                    <option value="10" selected>10</option>
                </select>
                <input type="submit">
            </form>
        </div>
    </div>
    <script>
        // ... (your script for modal)
    </script>
<% } %>

<div class="reviews">
    <% if (anime.reviews.length) { %>
        <div class="review-table">
            <% let total = 0 %>
            <% anime.reviews.forEach(function(r) { %>
                <span>
                    <% total += r.rating %>
                </span>
                <div class="review">
                    <% if(user?._id.equals(r.user)) { %>
                        <form action="/reviews/<%= r._id %>?_method=DELETE" method="POST" class="delete-review">
                            <button type="submit">‚ùå</button>
                        </form>
                    <% } %>
                    <div class="review-user">
                        <img src="<%= r.userAvatar %>" alt="avatar" referrerpolicy="no-referrer">
                        <div class="user-name"><%= r.userName %></div>
                    </div>
                    <div class="review-details">
                        <div class="review-date"><%= r.createdAt.toLocaleDateString() %></div>
                        <div class="review-content"><%= r.content %></div>
                        <div class="review-rating"><%= r.rating %></div>
                        <% if(user?._id.equals(r.user)) { %>
                            <button class="editReviewBtn" data-modal-id="<%= r._id %>">EDIT</button>

                            <div class="editModal modal" data-modal-id="<%= r._id %>" style="display: none;">
                                <!-- ... (your edit review form) ... -->
                            </div>
                        <% } %>
                    </div>
                </div>
            <% }); %>
            <div class="average-rating">
                <div class="average-rating-label">Average Rating:</div>
                <div class="average-rating-value"><strong><%= (total/anime.reviews.length).toFixed(1) %></strong></div>
            </div>
        </div>
    <% } else { %>
        <h4>No Reviews Yet</h4>
    <% } %>
</div>


</div>

<%- include('../partials/footer') %>
